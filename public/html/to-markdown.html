
<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>文件转 Markdown</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.1.1/css/all.min.css">
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f9fafb;
            transition: background-color 0.3s, color 0.3s;
        }
        .dark body {
            background-color: #1f2937; /* gray-800 */
            color: #d1d5db; /* gray-300 */
        }
        .dark .converter-container, .dark .bg-white {
            background-color: #374151; /* gray-700 */
            border-color: #4b5563; /* gray-600 */
        }
        .dark .text-gray-700 { color: #d1d5db; /* gray-300 */ }
        .dark .text-gray-800 { color: #f3f4f6; /* gray-100 */ }
        .dark .text-gray-500 { color: #9ca3af; /* gray-400 */ }
        .dark .border-gray-200 { border-color: #4b5563; /* gray-600 */ }
        .dark .border-gray-300 { border-color: #4b5563; /* gray-600 */ }
        .dark .bg-gray-50 { background-color: #4b5563; /* gray-600 */ }
        .dark .api-key-input {
            background-color: rgba(99, 102, 241, 0.2); /* Lighter indigo for dark mode */
            border: 1px solid #818cf8; /* Lighter indigo border */
            color: #e0e7ff; /* Light text for dark input */
        }
        .dark .markdown-output, .dark .markdown-preview-html {
            background-color: #2d3748; /* gray-800 slightly lighter */
            border-color: #4a5568; /* gray-600 */
            color: #e2e8f0; /* slate-200 */
        }
        .dark .markdown-preview-html h1, .dark .markdown-preview-html h2, .dark .markdown-preview-html h3 { color: #e0e7ff; }
        .dark .markdown-preview-html p, .dark .markdown-preview-html li { color: #cbd5e0; }
        .dark .markdown-preview-html a { color: #93c5fd; }
        .dark .markdown-preview-html code { background-color: #374151; color: #f0f0f0; }
        .dark .markdown-preview-html pre { background-color: #1f2937; }

        .dark .file-item { background-color: #4b5563; /* gray-600 */ }
        .dark .file-item:hover { box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.3), 0 2px 4px -1px rgba(0, 0, 0, 0.2); }
        .dark .code-block { background-color: #2d3748; color: #cbd5e0; }
        .dark .api-response { background-color: #2d3748; color: #cbd5e0; }
        .dark #preview-file-select, .dark #model-select {
            background-color: #4b5563; /* gray-600 */
            color: #e0e7ff;
            border-color: #6b7280; /* gray-500 */
        }
        .dark .bg-gray-200 { background-color: #4b5563; }
        .dark .hover\:bg-gray-300:hover { background-color: #6b7280; }
        .dark .tab-button-active { background-color: #6366f1; color: white; }
        .dark .tab-button-inactive { background-color: #4b5563; color: #d1d5db; }


        .converter-container {
            min-height: calc(100vh - 4rem);
        }
        .file-input-container {
            border: 2px dashed #6366f1;
            transition: all 0.3s ease;
        }
        .file-input-container:hover, .file-input-container.dragging {
            background-color: rgba(99, 102, 241, 0.1);
            border-color: #4f46e5;
        }
        .file-preview {
            max-height: 400px;
            overflow-y: auto;
        }
        .api-key-input {
            background-color: rgba(99, 102, 241, 0.1);
            border: 1px solid #6366f1;
        }
        .markdown-output, .markdown-preview-html {
            background-color: #ffffff;
            border: 1px solid #e5e7eb;
            font-family: monospace; /* For raw markdown */
            white-space: pre-wrap; /* For raw markdown */
            min-height: 16rem; /* Ensure it has some height */
            max-height: 40rem;
            overflow-y: auto;
        }
        .markdown-preview-html {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; /* For rendered HTML */
            white-space: normal;
        }
        /* Basic styling for rendered Markdown if Tailwind prose isn't fully effective or for non-prose elements */
        .markdown-preview-html h1, .markdown-preview-html h2, .markdown-preview-html h3, .markdown-preview-html h4 { margin-top: 1em; margin-bottom: 0.5em; font-weight: bold; }
        .markdown-preview-html h1 { font-size: 2em; }
        .markdown-preview-html h2 { font-size: 1.5em; }
        .markdown-preview-html h3 { font-size: 1.17em; }
        .markdown-preview-html p { margin-bottom: 1em; line-height: 1.6; }
        .markdown-preview-html ul, .markdown-preview-html ol { margin-left: 1.5em; margin-bottom: 1em; }
        .markdown-preview-html li { margin-bottom: 0.25em; }
        .markdown-preview-html a { color: #3b82f6; text-decoration: underline; }
        .markdown-preview-html code { background-color: #f3f4f6; padding: 0.2em 0.4em; border-radius: 3px; font-family: monospace; }
        .dark .markdown-preview-html code { background-color: #374151; color: #e5e7eb; }
        .markdown-preview-html pre { background-color: #f3f4f6; padding: 1em; border-radius: 5px; overflow-x: auto; }
        .dark .markdown-preview-html pre { background-color: #1f2937; }
        .markdown-preview-html pre code { background-color: transparent; padding: 0; }
        .markdown-preview-html blockquote { border-left: 4px solid #d1d5db; padding-left: 1em; margin-left: 0; margin-bottom: 1em; color: #6b7280; }
        .dark .markdown-preview-html blockquote { border-left-color: #4b5563; color: #9ca3af; }
        .markdown-preview-html table { border-collapse: collapse; width: 100%; margin-bottom: 1em; }
        .markdown-preview-html th, .markdown-preview-html td { border: 1px solid #d1d5db; padding: 0.5em; text-align: left; }
        .dark .markdown-preview-html th, .dark .markdown-preview-html td { border-color: #4b5563; }
        .markdown-preview-html th { background-color: #f9fafb; }
        .dark .markdown-preview-html th { background-color: #374151; }


        .file-item {
            background-color: #ffffff;
            transition: all 0.2s ease;
        }
        .file-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }
        .theme-toggle {
            background-color: #4f46e5;
        }
        .theme-toggle:hover {
            background-color: #4338ca;
        }
        .btn-primary {
            background-color: #6366f1;
            transition: all 0.2s ease;
        }
        .btn-primary:hover {
            background-color: #4f46e5;
        }
        .btn-primary:disabled {
            background-color: #a5b4fc; /* indigo-300 */
            cursor: not-allowed;
        }
        .btn-secondary {
            background-color: #9ca3af;
            transition: all 0.2s ease;
        }
        .btn-secondary:hover {
            background-color: #6b7280;
        }
        .loader {
            border-top-color: #6366f1;
            animation: spinner 1s linear infinite;
        }
        @keyframes spinner {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .code-block {
            background-color: #1e1e1e;
            color: #d4d4d4;
            border-radius: 0.375rem;
            padding: 1rem;
            margin: 1rem 0;
        }
        .api-response {
            background-color: #f8f9fa;
            border-radius: 0.375rem;
            padding: 1rem;
            margin: 1rem 0;
            font-family: monospace;
            max-height: 300px;
            overflow: auto;
        }
        .tab-button {
            padding: 0.5rem 1rem;
            border-radius: 0.375rem;
            font-weight: 500;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        .tab-button-active {
            background-color: #6366f1; /* indigo-500 */
            color: white;
        }
        .tab-button-inactive {
            background-color: #e5e7eb; /* gray-200 */
            color: #374151; /* gray-700 */
        }
        .tab-button-inactive:hover {
            background-color: #d1d5db; /* gray-300 */
        }

        [v-cloak] { display: none; }
    </style>
</head>
<body class="bg-gray-50">
    <div id="app" v-cloak>
        <header class="bg-indigo-600 text-white py-4">
            <div class="container mx-auto px-4 flex justify-between items-center">
                <h1 class="text-2xl font-bold">文件转 Markdown</h1>
                <div class="flex items-center space-x-4">
                    <button @click="toggleTheme" class="theme-toggle p-2 rounded-full text-white">
                        <i class="fas" :class="isDarkMode ? 'fa-sun' : 'fa-moon'"></i>
                    </button>
                </div>
            </div>
        </header>

        <main class="container mx-auto px-4 py-8">
            <div class="converter-container bg-white rounded-lg shadow-lg p-6 mb-8">
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                    <!-- 左侧：上传和配置区域 -->
                    <div>
                        <h2 class="text-xl font-semibold mb-4 text-gray-800">文件上传</h2>
                        <div
                            @dragenter.prevent="handleDragEnter"
                            @dragover.prevent="handleDragOver"
                            @dragleave.prevent="handleDragLeave"
                            @drop.prevent="handleFileDrop"
                            @click="triggerFileInput"
                            class="file-input-container rounded-lg p-8 mb-6 text-center cursor-pointer"
                            :class="{ 'dragging': isDragging }"
                        >
                            <input type="file" ref="fileInput" @change="handleFileSelect" class="hidden" multiple>
                            <i class="fas fa-cloud-upload-alt text-4xl text-indigo-500 mb-4"></i>
                            <p class="text-lg text-gray-700">拖放文件到此处或<span class="text-indigo-600 font-medium">点击选择文件</span></p>
                            <p class="text-sm text-gray-500 mt-2">支持: .docx, .txt, .pdf, .html, 图片, 音视频等</p>
                        </div>

                        <div v-if="uploadedFiles.length > 0" class="mb-6">
                            <h3 class="text-lg font-medium mb-3 text-gray-800">已选择的文件 ({{ uploadedFiles.length }})</h3>
                            <div class="space-y-2 max-h-60 overflow-y-auto">
                                <div v-for="(file, index) in uploadedFiles" :key="file.id" class="file-item flex justify-between items-center p-3 rounded-lg shadow-sm border border-gray-200">
                                    <div class="flex items-center overflow-hidden">
                                        <i :class="getFileIconClass(file.name)" class="text-xl text-indigo-500 mr-3 flex-shrink-0"></i>
                                        <div class="truncate">
                                            <p class="font-medium text-gray-800 truncate" :title="file.name">{{ file.name }}</p>
                                            <p class="text-xs text-gray-500">{{ formatFileSize(file.size) }}</p>
                                        </div>
                                    </div>
                                    <div class="flex items-center space-x-2 flex-shrink-0">
                                        <button @click="selectFileForPreview(index)" class="p-1 rounded-full hover:bg-gray-100 dark:hover:bg-gray-500" title="预览">
                                            <i class="fas fa-eye text-gray-600 dark:text-gray-300"></i>
                                        </button>
                                        <button @click="removeFile(index)" class="p-1 rounded-full hover:bg-gray-100 dark:hover:bg-gray-500" title="移除">
                                            <i class="fas fa-times text-gray-600 dark:text-gray-300"></i>
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="mb-6">
                            <h3 class="text-lg font-medium mb-3 text-gray-800">转换配置</h3>
                            <div class="space-y-4">
                                <div>
                                  <label for="api-url" class="block text-sm font-medium text-gray-700 mb-1">API Url</label>
                                  <input type="text" v-model="apiUrl" @blur="saveApiUrl" id="api-url" placeholder="输入您的 API Url" class="api-key-input w-full px-4 py-2 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500">
                                </div>
                                <div>
                                    <label for="api-key" class="block text-sm font-medium text-gray-700 mb-1">API Key</label>
                                    <input type="password" v-model="apiKey" @blur="saveApiKey" id="api-key" placeholder="输入您的 API Key" class="api-key-input w-full px-4 py-2 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500">
                                </div>
                                
                                <div>
                                    <label for="model-select" class="block text-sm font-medium text-gray-700 mb-1">选择模型</label>
                                    <select v-model="selectedModel" id="model-select" class="w-full px-4 py-2 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-indigo-500">
                                        <option value="gemini-2.0-flash-exp">gemini-2.0-flash-exp</option>
                                        <option value="gemini-2.5-flash-preview-04-17">gemini-2.5-flash-preview-04-17</option>
                                        <option value="gemini-2.5-flash-preview-05-20">gemini-2.5-flash-preview-05-20</option>
                                    </select>
                                </div>
                                
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">转换选项</label>
                                    <div class="flex flex-wrap gap-x-4 gap-y-2">
                                        <label class="inline-flex items-center cursor-pointer">
                                            <input type="checkbox" v-model="includeToc" class="rounded text-indigo-600 focus:ring-indigo-500">
                                            <span class="ml-2 text-gray-700">包含目录</span>
                                        </label>
                                        <label class="inline-flex items-center cursor-pointer">
                                            <input type="checkbox" v-model="preserveFormatting" class="rounded text-indigo-600 focus:ring-indigo-500">
                                            <span class="ml-2 text-gray-700">保留格式</span>
                                        </label>
                                        <label class="inline-flex items-center cursor-pointer">
                                            <input type="checkbox" v-model="extractImages" class="rounded text-indigo-600 focus:ring-indigo-500">
                                            <span class="ml-2 text-gray-700">提取图片/图中文字</span>
                                        </label>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="flex flex-wrap gap-4">
                            <button @click="convertFiles" :disabled="isLoading || uploadedFiles.length === 0" class="btn-primary px-6 py-2 rounded-lg text-white font-medium flex items-center">
                                <i class="fas fa-sync-alt mr-2" :class="{'animate-spin': isLoading}"></i>
                                {{ isLoading ? '转换中...' : '转换' }}
                            </button>
                            <button @click="clearAll" class="btn-secondary px-6 py-2 rounded-lg text-white font-medium flex items-center">
                                <i class="fas fa-times mr-2"></i>清除
                            </button>
                        </div>
                    </div>

                    <!-- 右侧：预览和结果区域 -->
                    <div>
                        <div class="flex justify-between items-center mb-4">
                            <h2 class="text-xl font-semibold text-gray-800">文件预览</h2>
                            <select v-if="uploadedFiles.length > 1" v-model="currentPreviewFileIndex" @change="updatePreviewDisplay" class="px-3 py-1 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-indigo-500 text-sm">
                                <option v-for="(file, index) in uploadedFiles" :key="file.id" :value="index">{{ file.name }}</option>
                            </select>
                        </div>

                        <div class="file-preview rounded-lg border border-gray-200 p-4 mb-6 bg-gray-50 h-64 flex items-center justify-center text-gray-500">
                            <div v-if="currentPreviewFile" class="w-full h-full">
                                <p v-if="previewLoading" class="text-center">加载预览中...</p>
                                <template v-else>
                                    <img v-if="previewContent.type === 'image'" :src="previewContent.data" :alt="currentPreviewFile.name" class="max-h-full max-w-full object-contain mx-auto">
                                    <embed v-else-if="previewContent.type === 'pdf'" :src="previewContent.data" type="application/pdf" class="w-full h-full" />
                                    <audio v-else-if="previewContent.type === 'audio'" :src="previewContent.data" controls class="w-full"></audio>
                                    <video v-else-if="previewContent.type === 'video'" :src="previewContent.data" controls class="max-h-full max-w-full object-contain mx-auto"></video>
                                    <pre v-else-if="previewContent.type === 'text'" class="text-sm text-gray-800 whitespace-pre-wrap w-full h-full overflow-auto">{{ previewContent.data }}</pre>
                                    <div v-else class="text-center">
                                        <i :class="getFileIconClass(currentPreviewFile.name)" class="text-5xl text-indigo-500 mb-3"></i>
                                        <p class="text-gray-800">{{ currentPreviewFile.name }}</p>
                                        <p class="text-sm text-gray-500 mt-1">{{ formatFileSize(currentPreviewFile.size) }}</p>
                                        <p class="text-xs text-gray-400 mt-4">此文件类型无法直接预览内容</p>
                                    </div>
                                </template>
                            </div>
                            <p v-else>上传文件后将在此处预览</p>
                        </div>

                        <div>
                            <div class="flex justify-between items-center mb-2">
                                <h2 class="text-xl font-semibold text-gray-800">转换结果</h2>
                                <div class="flex space-x-2">
                                     <button @click="showRawMarkdown = true" 
                                            :class="showRawMarkdown ? 'tab-button-active' : 'tab-button-inactive dark:tab-button-inactive'" 
                                            class="tab-button text-sm">
                                        Raw
                                    </button>
                                    <button @click="showRawMarkdown = false" 
                                            :class="!showRawMarkdown ? 'tab-button-active' : 'tab-button-inactive dark:tab-button-inactive'"
                                            class="tab-button text-sm">
                                        预览HTML
                                    </button>
                                    <button v-if="markdownOutput && showRawMarkdown" @click="copyMarkdown" class="px-3 py-1 bg-gray-200 hover:bg-gray-300 dark:bg-gray-600 dark:hover:bg-gray-500 rounded-lg text-gray-700 dark:text-gray-200 font-medium flex items-center text-sm">
                                        <i class="fas mr-1" :class="copySuccess ? 'fa-check' : 'fa-copy'"></i>
                                        {{ copySuccess ? '已复制' : '复制' }}
                                    </button>
                                </div>
                            </div>
                            <div v-show="showRawMarkdown" class="markdown-output rounded-lg p-4 h-64 overflow-y-auto">
                                <textarea v-if="markdownOutput" v-model="markdownOutput" class="text-gray-800 w-full h-full border-none focus:outline-none resize-none bg-transparent" style="font-family: monospace;"></textarea>
                                <p v-else class="text-gray-500">转换结果将在此处显示</p>
                            </div>
                            <div v-show="!showRawMarkdown" class="markdown-preview-html prose dark:prose-invert max-w-none rounded-lg p-4 h-64 overflow-y-auto">
                                <div v-if="markdownOutput" v-html="renderedMarkdownHtml"></div>
                                <p v-else class="text-gray-500">无内容可预览</p>
                            </div>
                        </div>
                        
                         <div v-if="apiError" class="mt-6 p-4 bg-red-100 border border-red-400 text-red-700 rounded-lg">
                            <h3 class="text-lg font-medium mb-2">API 错误</h3>
                            <pre class="text-sm whitespace-pre-wrap">{{ apiError }}</pre>
                        </div>
                    </div>
                </div>
            </div>

            <div class="bg-white rounded-lg shadow-lg p-6">
                <h2 class="text-xl font-semibold mb-4 text-gray-800">使用说明</h2>
                <div class="space-y-4 text-gray-700">
                    <p>此工具可将多种格式的文件转换为标准Markdown格式。以OpenAI兼容的格式发送请求，以充分利用Gemini模型的多模态识别能力。</p>
                    <div>
                        <h3 class="text-lg font-medium mb-2">主要功能</h3>
                        <ul class="list-disc pl-5 space-y-1">
                            <li>支持多文件同时上传和批量转换 (逐个处理)。</li>
                            <li>支持多种文件格式：Word, PDF, TXT, HTML, 图片, 音视频等。</li>
                            <li>文件内容实时预览 (图片, PDF, 文本, 音视频)。</li>
                            <li>通过API进行智能转换，可配置选项，支持流式输出。</li>
                            <li>Markdown结果可切换原始文本和HTML预览。</li>
                        </ul>
                    </div>
                </div>
            </div>
        </main>

        <div v-if="globalLoading" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
            <div class="bg-white p-6 rounded-lg shadow-xl flex flex-col items-center dark:bg-gray-700">
                <div class="loader w-12 h-12 border-4 border-gray-200 rounded-full mb-4 dark:border-gray-500"></div>
                <p class="text-gray-800 font-medium dark:text-gray-200">{{ globalLoadingMessage }}</p>
            </div>
        </div>
    </div>

    <script src="https://unpkg.com/vue@3/dist/vue.global.prod.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script>
        const { createApp, ref, reactive, computed, onMounted, watch } = Vue;

        createApp({
            setup() {
                const uploadedFiles = ref([]);
                const apiUrl = ref('https://asnlee-gemini.hf.space/openai/v1/chat/completions');
                const apiKey = ref('');
                const selectedModel = ref('gemini-2.0-flash-exp'); // Default to cURL example model
                const includeToc = ref(false);
                const preserveFormatting = ref(false);
                const extractImages = ref(false); // For prompt construction
                
                const markdownOutput = ref('');
                const apiError = ref('');

                const isLoading = ref(false); 
                const globalLoading = ref(false);
                const globalLoadingMessage = ref('');

                const isDragging = ref(false);
                const fileInput = ref(null); 

                const currentPreviewFileIndex = ref(-1);
                const previewContent = reactive({ type: '', data: '' });
                const previewLoading = ref(false);

                const copySuccess = ref(false);
                const isDarkMode = ref(false);
                const showRawMarkdown = ref(true);


                const currentPreviewFile = computed(() => {
                    return currentPreviewFileIndex.value >= 0 && currentPreviewFileIndex.value < uploadedFiles.value.length
                        ? uploadedFiles.value[currentPreviewFileIndex.value]
                        : null;
                });

                const renderedMarkdownHtml = computed(() => {
                    if (window.marked && markdownOutput.value) {
                        return marked.parse(markdownOutput.value);
                    }
                    return '';
                });

                const triggerFileInput = () => {
                    fileInput.value.click();
                };

                const handleDragEnter = (e) => { isDragging.value = true; };
                const handleDragOver = (e) => { isDragging.value = true; }; 
                const handleDragLeave = (e) => { isDragging.value = false; };
                
                const handleFileDrop = (e) => {
                    isDragging.value = false;
                    addFiles(e.dataTransfer.files);
                };

                const handleFileSelect = (e) => {
                    addFiles(e.target.files);
                    e.target.value = null; 
                };

                const addFiles = (files) => {
                    if (!files) return;
                    const newFiles = Array.from(files).filter(file => 
                        !uploadedFiles.value.some(f => f.name === file.name && f.size === file.size)
                    ).map(file => ({
                        id: Date.now() + Math.random(), 
                        fileObject: file,
                        name: file.name,
                        size: file.size,
                        type: file.type
                    }));

                    uploadedFiles.value = [...uploadedFiles.value, ...newFiles];
                    if (uploadedFiles.value.length > 0 && currentPreviewFileIndex.value === -1) {
                        selectFileForPreview(0);
                    } else if (newFiles.length > 0 && currentPreviewFileIndex.value === -1) {
                         selectFileForPreview(uploadedFiles.value.length - newFiles.length);
                    }
                };
                
                const removeFile = (index) => {
                    uploadedFiles.value.splice(index, 1);
                    if (currentPreviewFileIndex.value === index) {
                        if (uploadedFiles.value.length > 0) {
                            selectFileForPreview(Math.max(0, index -1));
                        } else {
                            currentPreviewFileIndex.value = -1;
                            previewContent.type = '';
                            previewContent.data = '';
                        }
                    } else if (currentPreviewFileIndex.value > index) {
                        currentPreviewFileIndex.value--;
                    }
                };

                const selectFileForPreview = (index) => {
                    currentPreviewFileIndex.value = index;
                };

                watch(currentPreviewFileIndex, (newIndex) => {
                    updatePreviewDisplay();
                });

                const updatePreviewDisplay = async () => {
                    if (currentPreviewFile.value && currentPreviewFile.value.fileObject) {
                        // Clean up previous object URL if it exists and is for PDF/Audio/Video
                        if (previewContent.data && (previewContent.type === 'pdf' || previewContent.type === 'audio' || previewContent.type === 'video')) {
                            URL.revokeObjectURL(previewContent.data);
                        }
                    }

                    if (!currentPreviewFile.value) {
                        previewContent.type = '';
                        previewContent.data = '';
                        return;
                    }
                    previewLoading.value = true;
                    const file = currentPreviewFile.value.fileObject;
                    try {
                        if (file.type.startsWith('image/')) {
                            previewContent.type = 'image';
                            previewContent.data = await readFileAsDataURL(file);
                        } else if (file.type === 'application/pdf') {
                            previewContent.type = 'pdf';
                            previewContent.data = URL.createObjectURL(file); 
                        } else if (file.type.startsWith('audio/')) {
                            previewContent.type = 'audio';
                            previewContent.data = URL.createObjectURL(file);
                        } else if (file.type.startsWith('video/')) {
                            previewContent.type = 'video';
                            previewContent.data = URL.createObjectURL(file);
                        } else if (file.type.startsWith('text/') || /\.(txt|md|json|csv|html|xml|js|css)$/i.test(file.name)) {
                            previewContent.type = 'text';
                            previewContent.data = await readFileAsText(file);
                        } else if (file.type === 'application/vnd.openxmlformats-officedocument.wordprocessingml.document' || 
                                   file.type === 'application/msword' || 
                                   /\.(doc|docx)$/i.test(file.name)) {
                            previewContent.type = 'text';
                            try {
                                // 使用mammoth.js处理Word文档
                                const arrayBuffer = await file.arrayBuffer();
                                const result = await mammoth.extractRawText({ arrayBuffer: arrayBuffer });
                                previewContent.data = result.value || '无法提取文本内容';
                            } catch (error) {
                                console.error('处理Word文档时出错:', error);
                                previewContent.data = `处理Word文档时出错: ${error.message}`;
                            }
                        } else {
                            previewContent.type = 'other';
                            previewContent.data = '';
                        }
                    } catch (error) {
                        console.error("Error reading file for preview:", error);
                        previewContent.type = 'other';
                        previewContent.data = 'Error loading preview.';
                    } finally {
                        previewLoading.value = false;
                    }
                };


                const readFileAsDataURL = (file) => {
                    return new Promise((resolve, reject) => {
                        const reader = new FileReader();
                        reader.onload = () => resolve(reader.result);
                        reader.onerror = reject;
                        reader.readAsDataURL(file);
                    });
                };

                const readFileAsText = (file) => {
                    return new Promise((resolve, reject) => {
                        const reader = new FileReader();
                        reader.onload = () => resolve(reader.result);
                        reader.onerror = reject;
                        reader.readAsText(file);
                    });
                };

                const getFileIconClass = (filename) => {
                    const ext = filename.split('.').pop().toLowerCase();
                    const iconMap = {
                        'pdf': 'fas fa-file-pdf', 'doc': 'fas fa-file-word', 'docx': 'fas fa-file-word',
                        'xls': 'fas fa-file-excel', 'xlsx': 'fas fa-file-excel', 'ppt': 'fas fa-file-powerpoint',
                        'pptx': 'fas fa-file-powerpoint', 'txt': 'fas fa-file-alt', 'md': 'fab fa-markdown',
                        'jpg': 'fas fa-file-image', 'jpeg': 'fas fa-file-image', 'png': 'fas fa-file-image',
                        'gif': 'fas fa-file-image', 'svg': 'fas fa-file-image',
                        'html': 'fas fa-file-code', 'css': 'fas fa-file-code', 'js': 'fas fa-file-code', 
                        'json': 'fas fa-file-code', 'xml': 'fas fa-file-code', 'csv': 'fas fa-file-csv',
                        'zip': 'fas fa-file-archive', 'rar': 'fas fa-file-archive', '7z': 'fas fa-file-archive',
                        'mp3': 'fas fa-file-audio', 'wav': 'fas fa-file-audio', 'ogg': 'fas fa-file-audio',
                        'mp4': 'fas fa-file-video', 'webm': 'fas fa-file-video', 'mov': 'fas fa-file-video'
                    };
                    return iconMap[ext] || 'fas fa-file';
                };

                const formatFileSize = (bytes) => {
                    if (bytes === 0) return '0 Bytes';
                    const k = 1024;
                    const sizes = ['Bytes', 'KB', 'MB', 'GB', 'TB'];
                    const i = Math.floor(Math.log(bytes) / Math.log(k));
                    return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
                };

                const convertFiles = async () => {
                    if (uploadedFiles.value.length === 0) {
                        alert('请先上传至少一个文件');
                        return;
                    }
                    if (!apiKey.value) {
                        alert('请输入API Key');
                        return;
                    }

                    globalLoading.value = true;
                    isLoading.value = true;
                    markdownOutput.value = '';
                    apiError.value = '';
                    let combinedMarkdown = "";

                    for (let i = 0; i < uploadedFiles.value.length; i++) {
                        const fileWrapper = uploadedFiles.value[i];
                        const file = fileWrapper.fileObject;
                        globalLoadingMessage.value = `正在处理文件 ${i + 1}/${uploadedFiles.value.length}: ${file.name}`;
                        
                        try {
                            // 处理Word文档（doc, docx）
                            if (file.type === 'application/vnd.openxmlformats-officedocument.wordprocessingml.document' || 
                                file.type === 'application/msword' || 
                                /\.(doc|docx)$/i.test(file.name)) {
                                try {
                                    const arrayBuffer = await file.arrayBuffer();
                                    // 首先尝试使用convertToHtml方法
                                    const result = await mammoth.convertToHtml({ arrayBuffer: arrayBuffer });
                                    const htmlContent = result.value || '';
                                    
                                    // 简单的HTML到Markdown转换
                                    let markdownContent = htmlContent
                                        .replace(/<h1[^>]*>(.*?)<\/h1>/gi, '# $1\n')
                                        .replace(/<h2[^>]*>(.*?)<\/h2>/gi, '## $1\n')
                                        .replace(/<h3[^>]*>(.*?)<\/h3>/gi, '### $1\n')
                                        .replace(/<h4[^>]*>(.*?)<\/h4>/gi, '#### $1\n')
                                        .replace(/<h5[^>]*>(.*?)<\/h5>/gi, '##### $1\n')
                                        .replace(/<h6[^>]*>(.*?)<\/h6>/gi, '###### $1\n')
                                        .replace(/<p[^>]*>(.*?)<\/p>/gi, '$1\n\n')
                                        .replace(/<br\s*\/?>/gi, '\n')
                                        .replace(/<strong[^>]*>(.*?)<\/strong>/gi, '**$1**')
                                        .replace(/<b[^>]*>(.*?)<\/b>/gi, '**$1**')
                                        .replace(/<em[^>]*>(.*?)<\/em>/gi, '*$1*')
                                        .replace(/<i[^>]*>(.*?)<\/i>/gi, '*$1*')
                                        .replace(/<a[^>]*href="([^"]*)"[^>]*>(.*?)<\/a>/gi, '[$2]($1)')
                                        .replace(/<ul[^>]*>(.*?)<\/ul>/gis, '$1')
                                        .replace(/<ol[^>]*>(.*?)<\/ol>/gis, '$1')
                                        .replace(/<li[^>]*>(.*?)<\/li>/gi, '- $1\n')
                                        .replace(/<code[^>]*>(.*?)<\/code>/gi, '`$1`')
                                        .replace(/<pre[^>]*>(.*?)<\/pre>/gis, '```\n$1\n```\n')
                                        .replace(/<blockquote[^>]*>(.*?)<\/blockquote>/gis, '> $1\n')
                                        .replace(/<img[^>]*src="([^"]*)"[^>]*alt="([^"]*)"[^>]*>/gi, '![$2]($1)')
                                        .replace(/<img[^>]*src="([^"]*)"[^>]*>/gi, '![]($1)')
                                        .replace(/<hr[^>]*>/gi, '---\n')
                                        .replace(/<\/?(div|span|table|tr|td|th)[^>]*>/gi, '')
                                        .replace(/&nbsp;/gi, ' ')
                                        .replace(/&lt;/gi, '<')
                                        .replace(/&gt;/gi, '>')
                                        .replace(/&amp;/gi, '&')
                                        .replace(/&quot;/gi, '"')
                                        .replace(/\n{3,}/g, '\n\n') // 删除多余的空行
                                        .trim();
                                    
                                    // 直接将转换后的Markdown内容添加到markdownOutput
                                    markdownOutput.value += markdownContent;
                                    continue; // 跳过API调用，直接处理下一个文件
                                } catch (err) {
                                    console.error('处理Word文档时出错:', err);
                                    const errorMsg = `\n\n## Error processing: ${file.name}\n\n${err.message}\n\n---\n\n`;
                                    apiError.value += `Error processing ${file.name}: ${err.message}\n`;
                                    markdownOutput.value += errorMsg;
                                    continue; // 跳过API调用，直接处理下一个文件
                                }
                            }
                            
                            const base64DataUrl = await readFileAsDataURL(file); // This is "data:mime/type;base64,..."
                            
                            let userPromptText = `Please convert the content of the provided file (${file.name}) to Markdown format.`;
                            if (file.type.startsWith('image/') && extractImages.value) {
                                userPromptText += " If this is an image containing text, extract the text and format it. If it's primarily a visual image, describe it briefly in Markdown. If it's a document scan, convert its textual content.";
                            } else {
                                userPromptText += `\nConversion Options:\n- Include Table of Contents if applicable: ${includeToc.value}\n- Preserve Original Formatting where possible: ${preserveFormatting.value}`;
                            }
                            if (extractImages.value) {
                                userPromptText += `\n- If the document contains images with text, try to extract and include that text. If it contains purely graphical images, you can note their presence like "[Image: description]".`;
                            }

                            userPromptText += '\nNo explanation is needed, just enter the markdown text';

                            const messages = [
                                {
                                    role: "user",
                                    content: [
                                        { type: "text", text: userPromptText }
                                    ]
                                }
                            ];
                            
                            // Add image data if it's an image or if we want the model to process other file types as "images" (multimodal)
                            // For non-image files, sending them as base64 dataURL to an image_url field is a common way to use multimodal models
                            // if direct text extraction isn't feasible or desired client-side.
                            messages[0].content.push({
                                type: "image_url",
                                image_url: {
                                    url: base64DataUrl, // data:mime/type;base64,...
                                    // detail: "high" // Optional: for higher resolution processing if supported
                                }
                            });


                            const payload = {
                                model: selectedModel.value,
                                messages: messages,
                                temperature: 0.2, // As per original Gemini config
                                stream: false
                            };

                            const response = await fetch(apiUrl.value, {
                                method: 'POST',
                                headers: { 
                                    'Content-Type': 'application/json',
                                    'Authorization': `Bearer ${apiKey.value}` 
                                },
                                body: JSON.stringify(payload)
                            });

                            if (!response.ok) {
                                const errorData = await response.json().catch(() => ({ message: `HTTP error ${response.status}` }));
                                throw new Error(`API Error for ${file.name}: ${errorData.error?.message || errorData.message || `HTTP ${response.status}`}`);
                            }

                            // 处理非流式响应，直接获取完整结果
                            const responseData = await response.json();
                            
                            // 从响应中提取Markdown内容
                            if (responseData.choices && responseData.choices[0] && responseData.choices[0].message) {
                                let content = responseData.choices[0].message.content || '';
                                content = content.replace(/^```markdown\s*|```$/g, '').trim()

                                markdownOutput.value += content;
                            } else {
                                throw new Error(`无效的API响应格式: ${JSON.stringify(responseData)}`);
                            }

                        } catch (err) {
                            console.error('Conversion error:', err);
                            const errorMsg = `\n\n## Error processing: ${file.name}\n\n${err.message}\n\n---\n\n`;
                            apiError.value += `Error processing ${file.name}: ${err.message}\n`;
                            markdownOutput.value += errorMsg;
                        }
                    }
                    isLoading.value = false;
                    globalLoading.value = false;
                };

                const clearAll = () => {
                    uploadedFiles.value = [];
                    currentPreviewFileIndex.value = -1;
                    if (previewContent.data && (previewContent.type === 'pdf' || previewContent.type === 'audio' || previewContent.type === 'video')) {
                        URL.revokeObjectURL(previewContent.data);
                    }
                    previewContent.type = '';
                    previewContent.data = '';
                    markdownOutput.value = '';
                    apiError.value = '';
                    if(fileInput.value) fileInput.value.value = ''; 
                };

                const copyMarkdown = () => {
                    if (!markdownOutput.value) return;
                    navigator.clipboard.writeText(markdownOutput.value).then(() => {
                        copySuccess.value = true;
                        setTimeout(() => { copySuccess.value = false; }, 2000);
                    });
                };

                const toggleTheme = () => {
                    isDarkMode.value = !isDarkMode.value;
                    document.documentElement.classList.toggle('dark', isDarkMode.value);
                    localStorage.setItem('darkMode', isDarkMode.value);
                };
                
                const setStoreByKey = (key, value) => {
                  localStorage.setItem(key, value); // Use a different key for this endpoint
                };

                const getStoreByKey = (key, value) => {
                  return localStorage.getItem(key) || value
                };

                const saveApiKey = () => {
                    if (apiKey.value) {
                      setStoreByKey('geminiOpenAIApiKey', apiKey.value)
                    }
                };

                const saveApiUrl = () => {
                    if (apiUrl.value) {
                      setStoreByKey('geminiOpenAIApiUrl', apiUrl.value)
                    }
                };

                onMounted(() => {
                    const storedApiKey = getStoreByKey('geminiOpenAIApiKey');
                    const storedApiUrl = getStoreByKey('geminiOpenAIApiUrl');
                    if (storedApiKey) apiKey.value = storedApiKey;
                    if (storedApiUrl) apiUrl.value = storedApiUrl;

                    const storedDarkMode = localStorage.getItem('darkMode');
                    if (storedDarkMode === 'true') {
                        isDarkMode.value = true;
                        document.documentElement.classList.add('dark');
                    }
                    updatePreviewDisplay(); 
                });

                return {
                    uploadedFiles, apiUrl, apiKey, selectedModel, includeToc, preserveFormatting, extractImages,
                    markdownOutput, apiError, isLoading, globalLoading, globalLoadingMessage,
                    isDragging, fileInput, currentPreviewFileIndex, currentPreviewFile, previewContent, previewLoading,
                    copySuccess, isDarkMode, showRawMarkdown, renderedMarkdownHtml,
                    triggerFileInput, handleDragEnter, handleDragOver, handleDragLeave, handleFileDrop, handleFileSelect,
                    removeFile, selectFileForPreview, updatePreviewDisplay,
                    getFileIconClass, formatFileSize, convertFiles, clearAll, copyMarkdown, toggleTheme, saveApiUrl, saveApiKey
                };
            }
        }).mount('#app');
    </script>

    <!-- Mammoth.js for DOCX processing -->
    <script src="https://cdn.jsdelivr.net/npm/mammoth@1.4.0/mammoth.browser.min.js"></script>
</body>
</html>